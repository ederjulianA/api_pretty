<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title><%= metadata.titulo %></title>

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Estilos incrustados (se inyectarán desde pdfGenerator.js) -->
  <style>
    <%= styles %>

    @page {
      size: A4 landscape;
      margin: 0;
    }

    @page productos {
      size: A4 landscape;
      margin: 0;
    }

    * {
      box-sizing: border-box;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  </style>
</head>
<body>
  <!-- PORTADA -->
  <div class="portada">
    <div class="portada-background"></div>
    <div class="portada-content">
      <% if (metadata.empresa.logo) { %>
        <img src="<%= metadata.empresa.logo %>" alt="Logo" class="portada-logo">
      <% } %>
      <h1 class="portada-titulo"><%= metadata.titulo %></h1>
      <div class="portada-fecha"><%= metadata.fecha %></div>
      <div class="portada-stats">
        <div class="stat">
          <div class="stat-numero"><%= metadata.totalProductos %></div>
          <div class="stat-label">Productos</div>
        </div>
        <div class="stat">
          <div class="stat-numero"><%= categorias.length %></div>
          <div class="stat-label">Categorías</div>
        </div>
      </div>
    </div>
  </div>

  <!-- PÁGINA 2: GRACIAS -->
  <% if (metadata.imagenGracias) { %>
    <div class="page-break"></div>
    <div class="pagina-imagen-completa">
      <img src="<%= metadata.imagenGracias %>" alt="Gracias" class="imagen-pagina-completa">
    </div>
  <% } %>

  <!-- PÁGINA 3: FORMAS DE PAGO -->
  <% if (metadata.imagenFormasPago) { %>
    <div class="page-break"></div>
    <div class="pagina-imagen-completa">
      <img src="<%= metadata.imagenFormasPago %>" alt="Formas de Pago" class="imagen-pagina-completa">
    </div>
  <% } %>

  <!-- PRODUCTOS POR CATEGORÍA -->
  <% categorias.forEach((categoria, categoriaIndex) => {
    const productosCategoria = productos.filter(p => p.categoriaId === categoria.id);
    if (productosCategoria.length > 0) {
  %>
    <div class="page-break"></div>
    <div class="categoria-seccion">
      <%
        // Agrupar productos de 3 en 3 para controlar paginación
        const grupos = [];
        for (let i = 0; i < productosCategoria.length; i += 3) {
          grupos.push(productosCategoria.slice(i, i + 3));
        }
      %>

      <% grupos.forEach((grupo, grupoIndex) => { %>
        <div class="productos-page-container <%= grupoIndex === 0 ? 'primera-pagina-categoria' : '' %>">
          <h2 class="categoria-titulo-pagina <%= grupoIndex > 0 ? 'categoria-titulo-repetido' : '' %>"><%= categoria.nombre %></h2>
          <div class="productos-grid">
            <% grupo.forEach((producto) => { %>
            <div class="producto-card <%= producto.stock <= 0 ? 'agotado' : '' %>">
            <!-- Imagen -->
            <div class="producto-imagen-container">
              <% if (producto.imagenOptimizada) { %>
                <img src="<%= producto.imagenOptimizada %>"
                     alt="<%= producto.nombre %>"
                     class="producto-imagen"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="producto-imagen" style="background: var(--color-background); display: none; align-items: center; justify-content: center; color: var(--color-text-light); font-size: 8pt; padding: 10px; text-align: center;">
                  Sin imagen
                </div>
              <% } else { %>
                <div class="producto-imagen" style="background: var(--color-background); display: flex; align-items: center; justify-content: center; color: var(--color-text-light); font-size: 8pt; padding: 10px; text-align: center;">
                  Sin imagen
                </div>
              <% } %>
              <% if (producto.esNuevo) { %>
                <span class="badge-nuevo">NUEVO</span>
              <% } %>
              <% if (producto.stock <= 0) { %>
                <div class="overlay-agotado">AGOTADO</div>
              <% } %>
            </div>

            <!-- Info -->
            <div class="producto-info">
              <div class="producto-categoria">
                <%= producto.categoria %>
                <% if (producto.subcategoria) { %> › <%= producto.subcategoria %> <% } %>
              </div>
              <h3 class="producto-nombre"><%= producto.nombre %></h3>
              <div class="producto-sku">SKU: <%= producto.sku %></div>

              <!-- Precios -->
              <div class="producto-precios">
                <div class="precio precio-detal">
                  <div class="precio-label">Precio Detal</div>
                  <div class="precio-valor">$<%= producto.precioDetalle.toLocaleString('es-CO') %></div>
                </div>
                <div class="precio precio-mayor">
                  <div class="precio-label">Precio Mayor</div>
                  <div class="precio-valor">$<%= producto.precioMayor.toLocaleString('es-CO') %></div>
                </div>
              </div>
            </div>
          </div>
          <% }); %>
          </div>
        </div>
      <% }); %>
    </div>
  <% }
  }); %>
</body>
</html>
