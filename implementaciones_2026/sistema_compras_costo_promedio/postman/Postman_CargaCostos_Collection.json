{
	"info": {
		"_postman_id": "carga-costos-2026-02-09",
		"name": "API Pretty - Carga de Costos",
		"description": "Colecci√≥n completa para probar el sistema de carga inicial de costos con costo promedio ponderado.\n\n**Documentaci√≥n:** implementaciones_2026/sistema_compras_costo_promedio/\n\n**Flujo A - C√°lculo Autom√°tico (RECOMENDADO para 600+ productos):**\n1. Login ‚Üí Obtener token\n2. Calcular Autom√°tico ‚Üí Calcula costos desde precio mayor (solo art√≠culos SIN costo asignado)\n3. Resumen ‚Üí Verificar estado (validados vs alertas)\n4. [Si hay VALIDADO_CON_ALERTAS] ‚Üí Actualizar Estado ‚Üí Aprobar masivamente\n5. Alertas ‚Üí Revisar productos rechazados\n6. Aplicar ‚Üí Aplicar costos VALIDADOS a BD\n\n**Flujo B - Carga Manual (para pocos productos):**\n1. Login ‚Üí Obtener token\n2. Exportar ‚Üí Descargar Excel (incluye columnas informativas: costo actual, rentabilidad, unidades vendidas)\n3. Completar columna `costo_inicial` en el Excel\n4. Importar ‚Üí Subir Excel con costos completados\n5. Resumen ‚Üí Ver estado\n6. Alertas ‚Üí Revisar problemas\n7. Aplicar ‚Üí Aplicar costos VALIDADOS a BD\n\n**Notas importantes:**\n- `calcular-automatico` OMITE art√≠culos que ya tienen `art_bod_cos_cat > 0`\n- `aplicar` solo procesa registros en estado `VALIDADO` (no `VALIDADO_CON_ALERTAS`)\n- Para aprobar alertas masivamente usar `PUT /actualizar-estado`",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "0. Autenticaci√≥n",
			"item": [
				{
					"name": "Login - Obtener Token JWT",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Guardar el token autom√°ticamente",
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.token) {",
									"        pm.environment.set('jwt_token', jsonData.token);",
									"        console.log('‚úÖ Token guardado exitosamente');",
									"        console.log('Token:', jsonData.token.substring(0, 30) + '...');",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"{{username}}\",\n  \"usu_pass\": \"{{password}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/login",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"auth",
								"login"
							]
						},
						"description": "Autentica al usuario y devuelve un token JWT.\n\n**Variables de entorno necesarias:**\n- `username`: Usuario de la base de datos\n- `password`: Contrase√±a del usuario\n\n**El token se guarda autom√°ticamente en `jwt_token`**"
					},
					"response": [
						{
							"name": "Login Exitoso",
							"originalRequest": {
								"method": "POST",
								"header": [],
								"body": {
									"mode": "raw",
									"raw": "{\n  \"usu_cod\": \"admin\",\n  \"usu_pass\": \"password123\"\n}",
									"options": {
										"raw": {
											"language": "json"
										}
									}
								},
								"url": {
									"raw": "{{base_url}}/api/auth/login",
									"host": [
										"{{base_url}}"
									],
									"path": [
										"api",
										"auth",
										"login"
									]
								}
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"header": [],
							"cookie": [],
							"body": "{\n  \"success\": true,\n  \"token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"user\": {\n    \"usu_cod\": \"admin\",\n    \"usu_nom\": \"Administrador\"\n  }\n}"
						}
					]
				}
			],
			"description": "Endpoints de autenticaci√≥n para obtener el token JWT necesario."
		},
		{
			"name": "1. Exportar Plantilla Excel",
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/api/carga-costos/exportar",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"exportar"
					]
				},
				"description": "**GET** `/api/carga-costos/exportar`\n\nGenera y descarga un archivo Excel con TODOS los art√≠culos (sin importar existencia).\n\n**Headers requeridos:**\n- `x-access-token`: Token JWT\n\n**Respuesta:**\n- Archivo Excel (`.xlsx`) con las siguientes columnas:\n\n| Col | Campo | Editable | Descripci√≥n |\n|-----|-------|----------|-------------|\n| A | categoria | ‚ùå | Nombre de categor√≠a |\n| B | subcategoria | ‚ùå | Nombre de subcategor√≠a |\n| C | art_cod (SKU) | ‚ùå | C√≥digo del art√≠culo |\n| D | art_nom | ‚ùå | Nombre del art√≠culo |\n| E | existencia | ‚ùå | Stock actual (puede ser 0) |\n| F | precio_venta_detal | ‚ùå | Precio lista 1 |\n| G | precio_venta_mayor | ‚ùå | Precio lista 2 |\n| H | costo_promedio_actual | ‚ùå | Costo actual en articulosdetalle (0 = sin costo) |\n| I | rentabilidad_detal_pct | ‚ùå | % margen sobre precio detal (solo si tiene costo) |\n| J | rentabilidad_mayor_pct | ‚ùå | % margen sobre precio mayor (solo si tiene costo) |\n| K | total_unidades_vendidas | ‚ùå | Unidades vendidas en facturas tipo VTA activas |\n| **L** | **costo_inicial** | **‚úÖ** | **COMPLETAR: costo a asignar** |\n| **M** | **metodo** | **‚úÖ** | **COMPLETAR: m√©todo de c√°lculo** |\n| **N** | **observaciones** | **‚úÖ** | **COMPLETAR: notas adicionales** |\n\n**Importante:**\n- Columnas A‚ÄìK son de solo lectura (informativas)\n- Solo completar columnas L, M, N\n- Al importar, se usa la posici√≥n L como `costo_inicial`\n- Art√≠culos con `costo_promedio_actual > 0` ya tienen costo asignado"
			},
			"response": []
		},
		{
			"name": "2. Importar Costos desde Excel",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "formdata",
					"formdata": [
						{
							"key": "archivo",
							"type": "file",
							"src": "/path/to/carga_costos.xlsx",
							"description": "Archivo Excel con costos completados (m√°ximo 10MB)"
						},
						{
							"key": "usu_cod",
							"value": "{{username}}",
							"type": "text",
							"description": "Usuario que realiza la carga (opcional, se toma del token)"
						}
					]
				},
				"url": {
					"raw": "{{base_url}}/api/carga-costos/importar",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"importar"
					]
				},
				"description": "**POST** `/api/carga-costos/importar`\n\nImporta costos desde un archivo Excel con l√≥gica incremental (UPSERT).\n\n**Headers:**\n- `x-access-token`: Token JWT\n\n**Body (multipart/form-data):**\n- `archivo`: Archivo Excel (.xlsx, .xls) - **M√°ximo 10MB**\n- `usu_cod`: Usuario (opcional)\n\n**Estructura esperada del Excel:**\n- Columna L (posici√≥n 12): `costo_inicial` ‚Üê se lee de aqu√≠\n- Columna C (posici√≥n 3): `art_cod` (SKU) ‚Üê identificador\n- Columnas A‚ÄìK: informativas, ignoradas al importar\n- Columnas M‚ÄìN: metodo y observaciones\n\n**L√≥gica incremental:**\n- Si el producto YA existe en `carga_inicial_costos` ‚Üí **ACTUALIZA** el costo\n- Si es nuevo ‚Üí **INSERTA** el registro\n- Ignora filas sin `costo_inicial` completado\n- Ignora filas con SKU no encontrado en BD\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Importaci√≥n completada exitosamente\",\n  \"data\": {\n    \"total_filas\": 250,\n    \"procesados\": 70,\n    \"nuevos\": 40,\n    \"actualizados\": 30,\n    \"ignorados\": 180,\n    \"errores\": []\n  }\n}\n```"
			},
			"response": [
				{
					"name": "Importaci√≥n Exitosa",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "archivo",
									"type": "file",
									"src": "carga_costos.xlsx"
								}
							]
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/importar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"importar"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"Importaci√≥n completada exitosamente\",\n  \"data\": {\n    \"total_filas\": 250,\n    \"procesados\": 70,\n    \"nuevos\": 40,\n    \"actualizados\": 30,\n    \"ignorados\": 180,\n    \"errores\": [\n      \"Producto XYZ123: No encontrado en sistema\"\n    ]\n  }\n}"
				},
				{
					"name": "Error - Archivo No Enviado",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": []
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/importar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"importar"
							]
						}
					},
					"status": "Bad Request",
					"code": 400,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": false,\n  \"message\": \"No se recibi√≥ ning√∫n archivo Excel\"\n}"
				}
			]
		},
		{
			"name": "3. Calcular Costos Autom√°ticamente",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"usu_cod\": \"{{username}}\",\n  \"margen_mayor\": 25,\n  \"margen_detal\": 25\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{base_url}}/api/carga-costos/calcular-automatico",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"calcular-automatico"
					]
				},
				"description": "**POST** `/api/carga-costos/calcular-automatico`\n\n‚≠ê **RECOMENDADO** para clientes con 600+ productos sin historial de compras.\n\n**Prioridad de c√°lculo por art√≠culo:**\n1. Tiene precio mayor ‚Üí `Costo = Precio Mayor / (1 + margen_mayor/100)`\n2. Solo tiene precio detal ‚Üí `Costo = Precio Detal / (1 + margen_detal/100)`\n3. Sin ning√∫n precio ‚Üí se omite (`sin_precio`)\n\n**Diferencia importante: Markup vs Margen**\n```\nMarkup 20% ‚Üí Margen resultante 16.67%  (markup sobre costo)\nMarkup 25% ‚Üí Margen resultante 20.00%  (pasa validaci√≥n del SP)\nMarkup 30% ‚Üí Margen resultante 23.08%  (pasa sin alertas)\n```\nUsar `margen_mayor: 25` para obtener margen del 20% sobre precio venta.\n\n**‚ö†Ô∏è RESPETA art√≠culos con costo ya asignado:**\n- Si `art_bod_cos_cat > 0` ‚Üí se **OMITE** (no sobreescribe)\n- El contador `ya_con_costo` indica cu√°ntos se omitieron\n\n**Body (JSON):**\n```json\n{\n  \"usu_cod\": \"admin\",      // Opcional\n  \"margen_mayor\": 25,      // Markup para precio mayor (default: 20)\n  \"margen_detal\": 25       // Markup para precio detal (default: igual a margen_mayor)\n}\n```\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"total_productos\": 650,\n    \"procesados\": 500,\n    \"ya_con_costo\": 150,\n    \"calculados_desde_mayor\": 490,\n    \"calculados_desde_detal\": 10,\n    \"sin_precio\": 5,\n    \"nuevos\": 480,\n    \"actualizados\": 20,\n    \"markup_mayor_aplicado\": \"25%\",\n    \"markup_detal_aplicado\": \"25%\",\n    \"formulas\": {\n      \"desde_mayor\": \"Costo = Precio Mayor / 1.25\",\n      \"desde_detal\": \"Costo = Precio Detal / 1.25\"\n    }\n  }\n}\n```\n\n**Siguiente paso:**\n1. `GET /resumen` ‚Üí verificar estados\n2. Si hay `VALIDADO_CON_ALERTAS` ‚Üí `PUT /actualizar-estado` para aprobarlos\n3. `POST /aplicar` ‚Üí aplica solo los `VALIDADO`"
			},
			"response": [
				{
					"name": "C√°lculo Exitoso - Markup 25% (margen 20%)",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"admin\",\n  \"margen_mayor\": 25,\n  \"margen_detal\": 25\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/calcular-automatico",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"calcular-automatico"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"C√°lculo autom√°tico de costos completado exitosamente\",\n  \"data\": {\n    \"total_productos\": 650,\n    \"procesados\": 500,\n    \"ya_con_costo\": 150,\n    \"calculados_desde_mayor\": 490,\n    \"calculados_desde_detal\": 10,\n    \"sin_precio\": 5,\n    \"nuevos\": 480,\n    \"actualizados\": 20,\n    \"markup_mayor_aplicado\": \"25%\",\n    \"markup_detal_aplicado\": \"25%\",\n    \"formulas\": {\n      \"desde_mayor\": \"Costo = Precio Mayor / 1.25\",\n      \"desde_detal\": \"Costo = Precio Detal / 1.25\"\n    },\n    \"siguiente_paso\": \"Revisar con GET /api/carga-costos/resumen. Si hay VALIDADO_CON_ALERTAS usar PUT /actualizar-estado antes de aplicar.\"\n  }\n}"
				},
				{
					"name": "C√°lculo Exitoso - Markup 30% (sin alertas)",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"admin\",\n  \"margen_mayor\": 30,\n  \"margen_detal\": 30\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/calcular-automatico",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"calcular-automatico"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"C√°lculo autom√°tico de costos completado exitosamente\",\n  \"data\": {\n    \"total_productos\": 650,\n    \"procesados\": 500,\n    \"ya_con_costo\": 150,\n    \"calculados_desde_mayor\": 490,\n    \"calculados_desde_detal\": 10,\n    \"sin_precio\": 5,\n    \"nuevos\": 0,\n    \"actualizados\": 500,\n    \"markup_mayor_aplicado\": \"30%\",\n    \"markup_detal_aplicado\": \"30%\",\n    \"formulas\": {\n      \"desde_mayor\": \"Costo = Precio Mayor / 1.30\",\n      \"desde_detal\": \"Costo = Precio Detal / 1.30\"\n    }\n  }\n}"
				}
			]
		},
		{
			"name": "4. Obtener Resumen de Carga",
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/api/carga-costos/resumen",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"resumen"
					]
				},
				"description": "**GET** `/api/carga-costos/resumen`\n\nRetorna el estado actual de la carga de costos agrupado por estado.\n\n**Headers:**\n- `x-access-token`: Token JWT\n\n**Estados posibles:**\n- `PENDIENTE`: A√∫n no validado\n- `VALIDADO`: Aprobado autom√°ticamente (margen ‚â• 20%)\n- `VALIDADO_CON_ALERTAS`: Margen bajo (<20%), requiere revisi√≥n manual\n- `RECHAZADO`: Costo inv√°lido (negativo o mayor que precio venta)\n- `APLICADO`: Ya aplicado a `articulosdetalle`\n\n**‚ö†Ô∏è Nota:** El SP validador usa umbral `< 20%` para alertas. Con `margen_mayor: 20` muchos art√≠culos quedan en `VALIDADO_CON_ALERTAS`. Usar `PUT /actualizar-estado` para aprobarlos masivamente.\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"data\": [\n    { \"estado\": \"VALIDADO\", \"cantidad\": 65, \"margen_promedio\": 45.5 },\n    { \"estado\": \"VALIDADO_CON_ALERTAS\", \"cantidad\": 435, \"margen_promedio\": 20.0 },\n    { \"estado\": \"RECHAZADO\", \"cantidad\": 2, \"margen_promedio\": null },\n    { \"estado\": \"PENDIENTE\", \"cantidad\": 0, \"margen_promedio\": null }\n  ]\n}\n```"
			},
			"response": [
				{
					"name": "Resumen Exitoso",
					"originalRequest": {
						"method": "GET",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/carga-costos/resumen",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"resumen"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"data\": [\n    {\n      \"estado\": \"VALIDADO\",\n      \"cantidad\": 65,\n      \"margen_promedio\": 45.5\n    },\n    {\n      \"estado\": \"VALIDADO_CON_ALERTAS\",\n      \"cantidad\": 435,\n      \"margen_promedio\": 20.0\n    },\n    {\n      \"estado\": \"RECHAZADO\",\n      \"cantidad\": 2,\n      \"margen_promedio\": null\n    },\n    {\n      \"estado\": \"PENDIENTE\",\n      \"cantidad\": 0,\n      \"margen_promedio\": null\n    }\n  ]\n}"
				}
			]
		},
		{
			"name": "5. Obtener Productos con Alertas",
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/api/carga-costos/alertas",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"alertas"
					]
				},
				"description": "**GET** `/api/carga-costos/alertas`\n\nLista todos los productos que requieren revisi√≥n manual (con alertas o rechazados).\n\n**Headers:**\n- `x-access-token`: Token JWT\n\n**Retorna productos con:**\n- Estado: `VALIDADO_CON_ALERTAS` (margen <20%)\n- Estado: `RECHAZADO` (costo inv√°lido)\n\n**Casos de rechazo:**\n- Costo negativo\n- Costo mayor o igual que precio de venta\n\n**Casos de alerta:**\n- Margen resultante menor al 20%\n\n**Acci√≥n recomendada para VALIDADO_CON_ALERTAS:**\nSi los costos calculados son correctos, aprobarlos con `PUT /actualizar-estado`\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"data\": [\n    {\n      \"art_cod\": \"SM005\",\n      \"art_nom\": \"Sombra Mate Coral\",\n      \"costo_propuesto\": 25000,\n      \"precio_venta\": 30000,\n      \"margen\": 20.0,\n      \"estado\": \"VALIDADO_CON_ALERTAS\",\n      \"observaciones\": \" | ALERTA: Margen muy bajo (<20%)\"\n    }\n  ]\n}\n```"
			},
			"response": [
				{
					"name": "Alertas Encontradas",
					"originalRequest": {
						"method": "GET",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/carga-costos/alertas",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"alertas"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"data\": [\n    {\n      \"art_cod\": \"SM005\",\n      \"art_nom\": \"Sombra Mate Coral\",\n      \"costo_propuesto\": 25000,\n      \"precio_venta\": 30000,\n      \"margen\": 20.0,\n      \"estado\": \"VALIDADO_CON_ALERTAS\",\n      \"observaciones\": \" | ALERTA: Margen muy bajo (<20%)\"\n    },\n    {\n      \"art_cod\": \"LP012\",\n      \"art_nom\": \"Labial Premium Oro\",\n      \"costo_propuesto\": 65000,\n      \"precio_venta\": 60000,\n      \"margen\": -8.33,\n      \"estado\": \"RECHAZADO\",\n      \"observaciones\": \" | ERROR: Costo mayor o igual que precio venta\"\n    }\n  ]\n}"
				}
			]
		},
		{
			"name": "5b. Actualizar Estado (Aprobar Alertas Masivamente)",
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"estado_actual\": \"VALIDADO_CON_ALERTAS\",\n  \"nuevo_estado\": \"VALIDADO\",\n  \"usu_cod\": \"{{username}}\"\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{base_url}}/api/carga-costos/actualizar-estado",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"actualizar-estado"
					]
				},
				"description": "**PUT** `/api/carga-costos/actualizar-estado`\n\n‚ö†Ô∏è **PASO CR√çTICO** del flujo cuando se usa `calcular-automatico` con `margen_mayor: 20`.\n\nEl SP validador marca como `VALIDADO_CON_ALERTAS` todos los art√≠culos con margen < 20%. Como la f√≥rmula calcula exactamente 20%, la mayor√≠a de art√≠culos quedar√°n en `VALIDADO_CON_ALERTAS` en vez de `VALIDADO`. Este endpoint los aprueba masivamente.\n\n**Cu√°ndo usar:**\n- Despu√©s de `GET /resumen` cuando hay muchos `VALIDADO_CON_ALERTAS`\n- Antes de `POST /aplicar` (que solo procesa `VALIDADO`)\n\n**Headers:**\n- `x-access-token`: Token JWT\n- `Content-Type`: application/json\n\n**Body (JSON):**\n```json\n{\n  \"estado_actual\": \"VALIDADO_CON_ALERTAS\",   // Estado origen\n  \"nuevo_estado\": \"VALIDADO\",                 // Estado destino\n  \"usu_cod\": \"admin\"                          // Opcional\n}\n```\n\n**Casos de uso:**\n- `VALIDADO_CON_ALERTAS` ‚Üí `VALIDADO`: Aprobar art√≠culos con margen justo\n- `RECHAZADO` ‚Üí `PENDIENTE`: Re-procesar art√≠culos rechazados\n\n**No se recomienda:**\n- `RECHAZADO` ‚Üí `VALIDADO` sin revisar (pueden tener costos inv√°lidos)\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Estado actualizado: 435 registros de VALIDADO_CON_ALERTAS a VALIDADO\",\n  \"data\": {\n    \"afectados\": 435\n  }\n}\n```"
			},
			"response": [
				{
					"name": "Aprobaci√≥n masiva VALIDADO_CON_ALERTAS ‚Üí VALIDADO",
					"originalRequest": {
						"method": "PUT",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"estado_actual\": \"VALIDADO_CON_ALERTAS\",\n  \"nuevo_estado\": \"VALIDADO\",\n  \"usu_cod\": \"admin\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/actualizar-estado",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"actualizar-estado"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"Estado actualizado: 435 registros de VALIDADO_CON_ALERTAS a VALIDADO\",\n  \"data\": {\n    \"afectados\": 435\n  }\n}"
				},
				{
					"name": "Sin registros en estado origen",
					"originalRequest": {
						"method": "PUT",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"estado_actual\": \"VALIDADO_CON_ALERTAS\",\n  \"nuevo_estado\": \"VALIDADO\",\n  \"usu_cod\": \"admin\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/actualizar-estado",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"actualizar-estado"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"Estado actualizado: 0 registros de VALIDADO_CON_ALERTAS a VALIDADO\",\n  \"data\": {\n    \"afectados\": 0\n  }\n}"
				}
			]
		},
		{
			"name": "6. Aplicar Costos Validados",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"usu_cod\": \"{{username}}\"\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{base_url}}/api/carga-costos/aplicar",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"aplicar"
					]
				},
				"description": "**POST** `/api/carga-costos/aplicar`\n\nAplica todos los costos con estado `VALIDADO` a la tabla `articulosdetalle` y registra en el historial.\n\n**Headers:**\n- `x-access-token`: Token JWT\n- `Content-Type`: application/json\n\n**Body (JSON):**\n```json\n{\n  \"usu_cod\": \"maria.lopez\"  // Opcional, se toma del token\n}\n```\n\n**‚ö†Ô∏è IMPORTANTE:**\n- Esta operaci√≥n es **irreversible** (modifica costos en BD)\n- Solo aplica costos con estado `VALIDADO` (no `VALIDADO_CON_ALERTAS`)\n- Si `total_aplicados: 0` ‚Üí verificar con `GET /resumen` si hay registros en `VALIDADO`\n  - Puede que todos est√©n en `VALIDADO_CON_ALERTAS` ‚Üí usar `PUT /actualizar-estado` primero\n- Se registra todo en `historial_costos` para auditor√≠a\n\n**Proceso:**\n1. Actualiza `articulosdetalle.art_bod_cos_cat` (lista precio 1 y 2)\n2. Marca registros como `APLICADO` en `carga_inicial_costos`\n3. Inserta registros en `historial_costos` tipo `CARGA_INICIAL`\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Carga inicial aplicada exitosamente\",\n  \"data\": {\n    \"total_aplicados\": 500,\n    \"errores\": 0\n  }\n}\n```\n\n**Si retorna `total_aplicados: 0`:**\n1. Ejecutar `GET /resumen` para ver estados actuales\n2. Si hay `VALIDADO_CON_ALERTAS`, ejecutar `PUT /actualizar-estado` para aprobarlos\n3. Volver a ejecutar `POST /aplicar`"
			},
			"response": [
				{
					"name": "Aplicaci√≥n Exitosa",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"admin\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/aplicar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"aplicar"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"Carga inicial aplicada exitosamente\",\n  \"data\": {\n    \"total_aplicados\": 500,\n    \"errores\": 0\n  }\n}"
				},
				{
					"name": "Aplicaci√≥n con total_aplicados: 0 (sin VALIDADO)",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"admin\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/aplicar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"aplicar"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"Carga inicial aplicada exitosamente\",\n  \"data\": {\n    \"total_aplicados\": 0,\n    \"errores\": 0\n  }\n}"
				},
				{
					"name": "Error al Aplicar",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"admin\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/aplicar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"aplicar"
							]
						}
					},
					"status": "Internal Server Error",
					"code": 500,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": false,\n  \"message\": \"Error al aplicar los costos\",\n  \"error\": \"Detalle del error SQL\"\n}"
				}
			]
		}
	,
	{
		"name": "7. Actualizar Costos Masivo (Directo en BD)",
		"request": {
			"method": "POST",
			"header": [
				{
					"key": "x-access-token",
					"value": "{{jwt_token}}",
					"type": "text"
				},
				{
					"key": "Content-Type",
					"value": "application/json",
					"type": "text"
				}
			],
			"body": {
				"mode": "raw",
				"raw": "{\n  \"usu_cod\": \"admin\",\n  \"margen_mayor\": 25,\n  \"margen_detal\": 25,\n  \"forzar\": false\n}",
				"options": {
					"raw": {
						"language": "json"
					}
				}
			},
			"url": {
				"raw": "{{base_url}}/api/carga-costos/actualizar-costos-masivo",
				"host": [
					"{{base_url}}"
				],
				"path": [
					"api",
					"carga-costos",
					"actualizar-costos-masivo"
				]
			},
			"description": "Actualiza el costo (art_bod_cos_cat) directamente en articulosdetalle sin pasar por la tabla de staging.\n\nDiferencias vs /calcular-automatico:\n- Este endpoint actualiza DIRECTAMENTE articulosdetalle (operaci√≥n PERMANENTE)\n- /calcular-automatico solo propone costos en tabla temporal carga_inicial_costos\n\nPar√°metro forzar:\n- false (default): Solo actualiza art√≠culos con costo=0 o con margen actual < par√°metro\n- true: Actualiza TODOS los art√≠culos que tengan precio configurado\n\nPrioridad de precio:\n1. precio_mayor > 0 ‚Üí Costo = Precio Mayor / (1 + margen_mayor/100)\n2. Solo precio_detal > 0 ‚Üí Costo = Precio Detal / (1 + margen_detal/100)\n3. Sin ning√∫n precio ‚Üí se omite\n\nUSO RECOMENDADO: Para corregir costos que quedaron con margen insuficiente (ej: 16% en vez de 20%)"
		},
		"response": [
			{
				"name": "√âxito - Costos actualizados",
				"originalRequest": {
					"method": "POST",
					"header": [
						{
							"key": "x-access-token",
							"value": "{{jwt_token}}",
							"type": "text"
						},
						{
							"key": "Content-Type",
							"value": "application/json",
							"type": "text"
						}
					],
					"body": {
						"mode": "raw",
						"raw": "{\n  \"usu_cod\": \"admin\",\n  \"margen_mayor\": 25,\n  \"margen_detal\": 25,\n  \"forzar\": false\n}",
						"options": {
							"raw": {
								"language": "json"
							}
						}
					},
					"url": {
						"raw": "{{base_url}}/api/carga-costos/actualizar-costos-masivo",
						"host": [
							"{{base_url}}"
						],
						"path": [
							"api",
							"carga-costos",
							"actualizar-costos-masivo"
						]
					}
				},
				"status": "OK",
				"code": 200,
				"_postman_previewlanguage": "json",
				"header": [],
				"cookie": [],
				"body": "{\n  \"success\": true,\n  \"message\": \"Actualizaci√≥n masiva de costos completada\",\n  \"data\": {\n    \"total\": 650,\n    \"actualizados\": 435,\n    \"omitidos\": 210,\n    \"sin_precio\": 5,\n    \"calculados_desde_mayor\": 420,\n    \"calculados_desde_detal\": 15,\n    \"markup_mayor_aplicado\": \"25%\",\n    \"markup_detal_aplicado\": \"25%\"\n  }\n}"
			}
		]
	}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Este script se ejecuta antes de cada request",
					"console.log('üöÄ Ejecutando:', pm.request.name);",
					"",
					"// Verificar si hay token (excepto para login)",
					"if (pm.request.name !== 'Login - Obtener Token JWT') {",
					"    const token = pm.environment.get('jwt_token');",
					"    if (!token) {",
					"        console.warn('‚ö†Ô∏è No hay token JWT. Ejecuta primero el endpoint de Login.');",
					"    }",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script global para todas las respuestas",
					"console.log('üìä Status:', pm.response.code, pm.response.status);",
					"",
					"// Validar respuestas exitosas",
					"if (pm.response.code === 200) {",
					"    console.log('‚úÖ Request exitoso');",
					"} else if (pm.response.code === 401) {",
					"    console.error('üîí No autorizado - Token inv√°lido o expirado');",
					"} else if (pm.response.code === 400) {",
					"    console.warn('‚ö†Ô∏è Bad Request - Verificar datos enviados');",
					"}"
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:3000",
			"type": "string"
		},
		{
			"key": "jwt_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "username",
			"value": "admin",
			"type": "string"
		},
		{
			"key": "password",
			"value": "tu_password_aqui",
			"type": "string"
		}
	]
}
