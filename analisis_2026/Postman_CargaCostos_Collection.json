{
	"info": {
		"_postman_id": "carga-costos-2026-02-09",
		"name": "API Pretty - Carga de Costos",
		"description": "Colecci√≥n completa para probar el sistema de carga inicial de costos con costo promedio ponderado.\n\n**Documentaci√≥n:** analisis_2026/API_ENDPOINTS_CARGA_COSTOS.md\n\n**Flujo recomendado:**\n1. Login ‚Üí Obtener token\n2. Exportar ‚Üí Descargar Excel\n3. Importar ‚Üí Subir Excel con costos\n4. Resumen ‚Üí Ver estado\n5. Alertas ‚Üí Revisar problemas\n6. Aplicar ‚Üí Aplicar a BD",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "0. Autenticaci√≥n",
			"item": [
				{
					"name": "Login - Obtener Token JWT",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Guardar el token autom√°ticamente",
									"if (pm.response.code === 200) {",
									"    var jsonData = pm.response.json();",
									"    if (jsonData.token) {",
									"        pm.environment.set('jwt_token', jsonData.token);",
									"        console.log('‚úÖ Token guardado exitosamente');",
									"        console.log('Token:', jsonData.token.substring(0, 30) + '...');",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"{{username}}\",\n  \"usu_pass\": \"{{password}}\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/auth/login",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"auth",
								"login"
							]
						},
						"description": "Autentica al usuario y devuelve un token JWT.\n\n**Variables de entorno necesarias:**\n- `username`: Usuario de la base de datos\n- `password`: Contrase√±a del usuario\n\n**El token se guarda autom√°ticamente en `jwt_token`**"
					},
					"response": [
						{
							"name": "Login Exitoso",
							"originalRequest": {
								"method": "POST",
								"header": [],
								"body": {
									"mode": "raw",
									"raw": "{\n  \"usu_cod\": \"admin\",\n  \"usu_pass\": \"password123\"\n}",
									"options": {
										"raw": {
											"language": "json"
										}
									}
								},
								"url": {
									"raw": "{{base_url}}/api/auth/login",
									"host": [
										"{{base_url}}"
									],
									"path": [
										"api",
										"auth",
										"login"
									]
								}
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"header": [],
							"cookie": [],
							"body": "{\n  \"success\": true,\n  \"token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"user\": {\n    \"usu_cod\": \"admin\",\n    \"usu_nom\": \"Administrador\"\n  }\n}"
						}
					]
				}
			],
			"description": "Endpoints de autenticaci√≥n para obtener el token JWT necesario."
		},
		{
			"name": "1. Exportar Plantilla Excel",
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/api/carga-costos/exportar",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"exportar"
					]
				},
				"description": "**GET** `/api/carga-costos/exportar`\n\nGenera y descarga un archivo Excel con todos los productos activos.\n\n**Headers requeridos:**\n- `x-access-token`: Token JWT\n\n**Respuesta:**\n- Archivo Excel (`.xlsx`) con columnas:\n  - Categor√≠a, Subcategor√≠a, SKU, Nombre\n  - Existencia, Precio Venta Detal, Precio Venta Mayor\n  - **costo_inicial** (usuario completa)\n  - **metodo** (usuario completa)\n  - **observaciones** (usuario completa)\n\n**Nota:** Guardar el archivo descargado, completar las columnas editables y usarlo en el endpoint de importaci√≥n."
			},
			"response": []
		},
		{
			"name": "2. Importar Costos desde Excel",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "formdata",
					"formdata": [
						{
							"key": "archivo",
							"type": "file",
							"src": "/path/to/carga_costos.xlsx",
							"description": "Archivo Excel con costos completados (m√°ximo 10MB)"
						},
						{
							"key": "usu_cod",
							"value": "{{username}}",
							"type": "text",
							"description": "Usuario que realiza la carga (opcional, se toma del token)"
						}
					]
				},
				"url": {
					"raw": "{{base_url}}/api/carga-costos/importar",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"importar"
					]
				},
				"description": "**POST** `/api/carga-costos/importar`\n\nImporta costos desde un archivo Excel con l√≥gica incremental (UPSERT).\n\n**Headers:**\n- `x-access-token`: Token JWT\n\n**Body (multipart/form-data):**\n- `archivo`: Archivo Excel (.xlsx, .xls) - **M√°ximo 10MB**\n- `usu_cod`: Usuario (opcional)\n\n**L√≥gica incremental:**\n- Si el producto YA existe ‚Üí **ACTUALIZA** el costo\n- Si es nuevo ‚Üí **INSERTA** el registro\n- **NO genera errores de duplicados**\n\n**Validaciones:**\n- Solo procesa filas con `costo_inicial` completado\n- Ignora filas vac√≠as o sin SKU\n- Valida que el SKU exista en la BD\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Importaci√≥n completada exitosamente\",\n  \"data\": {\n    \"total_filas\": 250,\n    \"procesados\": 70,\n    \"nuevos\": 40,\n    \"actualizados\": 30,\n    \"ignorados\": 180,\n    \"errores\": []\n  }\n}\n```"
			},
			"response": [
				{
					"name": "Importaci√≥n Exitosa",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "archivo",
									"type": "file",
									"src": "carga_costos.xlsx"
								}
							]
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/importar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"importar"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"Importaci√≥n completada exitosamente\",\n  \"data\": {\n    \"total_filas\": 250,\n    \"procesados\": 70,\n    \"nuevos\": 40,\n    \"actualizados\": 30,\n    \"ignorados\": 180,\n    \"errores\": [\n      \"Producto XYZ123: No encontrado en sistema\"\n    ]\n  }\n}"
				},
				{
					"name": "Error - Archivo No Enviado",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							}
						],
						"body": {
							"mode": "formdata",
							"formdata": []
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/importar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"importar"
							]
						}
					},
					"status": "Bad Request",
					"code": 400,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": false,\n  \"message\": \"No se recibi√≥ ning√∫n archivo Excel\"\n}"
				}
			]
		},
		{
			"name": "3. Obtener Resumen de Carga",
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/api/carga-costos/resumen",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"resumen"
					]
				},
				"description": "**GET** `/api/carga-costos/resumen`\n\nRetorna el estado actual de la carga de costos agrupado por estado.\n\n**Headers:**\n- `x-access-token`: Token JWT\n\n**Estados posibles:**\n- `PENDIENTE`: A√∫n no validado\n- `VALIDADO`: Aprobado autom√°ticamente (margen ‚â• 20%)\n- `VALIDADO_CON_ALERTAS`: Margen bajo (<20%), requiere revisi√≥n\n- `RECHAZADO`: Costo inv√°lido (negativo o mayor que precio venta)\n- `APLICADO`: Ya aplicado a `articulosdetalle`\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"data\": [\n    { \"estado\": \"VALIDADO\", \"cantidad\": 65, \"margen_promedio\": 45.5 },\n    { \"estado\": \"VALIDADO_CON_ALERTAS\", \"cantidad\": 5, \"margen_promedio\": 18.2 },\n    { \"estado\": \"RECHAZADO\", \"cantidad\": 2, \"margen_promedio\": null },\n    { \"estado\": \"PENDIENTE\", \"cantidad\": 180, \"margen_promedio\": null }\n  ]\n}\n```"
			},
			"response": [
				{
					"name": "Resumen Exitoso",
					"originalRequest": {
						"method": "GET",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/carga-costos/resumen",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"resumen"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"data\": [\n    {\n      \"estado\": \"VALIDADO\",\n      \"cantidad\": 65,\n      \"margen_promedio\": 45.5\n    },\n    {\n      \"estado\": \"VALIDADO_CON_ALERTAS\",\n      \"cantidad\": 5,\n      \"margen_promedio\": 18.2\n    },\n    {\n      \"estado\": \"RECHAZADO\",\n      \"cantidad\": 2,\n      \"margen_promedio\": null\n    },\n    {\n      \"estado\": \"PENDIENTE\",\n      \"cantidad\": 180,\n      \"margen_promedio\": null\n    }\n  ]\n}"
				}
			]
		},
		{
			"name": "4. Obtener Productos con Alertas",
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/api/carga-costos/alertas",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"alertas"
					]
				},
				"description": "**GET** `/api/carga-costos/alertas`\n\nLista todos los productos que requieren revisi√≥n manual (con alertas o rechazados).\n\n**Headers:**\n- `x-access-token`: Token JWT\n\n**Retorna productos con:**\n- Estado: `VALIDADO_CON_ALERTAS` (margen <20%)\n- Estado: `RECHAZADO` (costo inv√°lido)\n\n**Casos de rechazo:**\n- Costo negativo\n- Costo mayor o igual que precio de venta\n\n**Casos de alerta:**\n- Margen resultante menor al 20%\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"data\": [\n    {\n      \"art_cod\": \"SM005\",\n      \"art_nom\": \"Sombra Mate Coral\",\n      \"costo_propuesto\": 41000,\n      \"precio_venta\": 50000,\n      \"margen\": 18.0,\n      \"estado\": \"VALIDADO_CON_ALERTAS\",\n      \"observaciones\": \" | ALERTA: Margen muy bajo (<20%)\"\n    }\n  ]\n}\n```"
			},
			"response": [
				{
					"name": "Alertas Encontradas",
					"originalRequest": {
						"method": "GET",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/api/carga-costos/alertas",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"alertas"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"data\": [\n    {\n      \"art_cod\": \"SM005\",\n      \"art_nom\": \"Sombra Mate Coral\",\n      \"costo_propuesto\": 41000,\n      \"precio_venta\": 50000,\n      \"margen\": 18.0,\n      \"estado\": \"VALIDADO_CON_ALERTAS\",\n      \"observaciones\": \" | ALERTA: Margen muy bajo (<20%)\"\n    },\n    {\n      \"art_cod\": \"LP012\",\n      \"art_nom\": \"Labial Premium Oro\",\n      \"costo_propuesto\": 65000,\n      \"precio_venta\": 60000,\n      \"margen\": -8.33,\n      \"estado\": \"RECHAZADO\",\n      \"observaciones\": \" | ERROR: Costo mayor o igual que precio venta\"\n    }\n  ]\n}"
				}
			]
		},
		{
			"name": "5. Aplicar Costos Validados",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "x-access-token",
						"value": "{{jwt_token}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"usu_cod\": \"{{username}}\"\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{base_url}}/api/carga-costos/aplicar",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"carga-costos",
						"aplicar"
					]
				},
				"description": "**POST** `/api/carga-costos/aplicar`\n\nAplica todos los costos con estado `VALIDADO` a la tabla `articulosdetalle` y registra en el historial.\n\n**Headers:**\n- `x-access-token`: Token JWT\n- `Content-Type`: application/json\n\n**Body (JSON):**\n```json\n{\n  \"usu_cod\": \"maria.lopez\"  // Opcional, se toma del token\n}\n```\n\n**‚ö†Ô∏è IMPORTANTE:**\n- Esta operaci√≥n es **irreversible** (modifica costos en BD)\n- Solo aplica costos con estado `VALIDADO`\n- Costos con alertas o rechazados **NO se aplican**\n- Se registra todo en `historial_costos` para auditor√≠a\n\n**Proceso:**\n1. Actualiza `articulosdetalle.art_bod_cos_cat` (lista precio 1)\n2. Marca registros como `APLICADO` en `carga_inicial_costos`\n3. Inserta registros en `historial_costos` tipo `CARGA_INICIAL`\n\n**Respuesta:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Carga inicial aplicada exitosamente\",\n  \"data\": {\n    \"total_aplicados\": 65,\n    \"errores\": 0\n  }\n}\n```"
			},
			"response": [
				{
					"name": "Aplicaci√≥n Exitosa",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"admin\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/aplicar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"aplicar"
							]
						}
					},
					"status": "OK",
					"code": 200,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": true,\n  \"message\": \"Carga inicial aplicada exitosamente\",\n  \"data\": {\n    \"total_aplicados\": 65,\n    \"errores\": 0\n  }\n}"
				},
				{
					"name": "Error al Aplicar",
					"originalRequest": {
						"method": "POST",
						"header": [
							{
								"key": "x-access-token",
								"value": "{{jwt_token}}"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"usu_cod\": \"admin\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/api/carga-costos/aplicar",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"carga-costos",
								"aplicar"
							]
						}
					},
					"status": "Internal Server Error",
					"code": 500,
					"_postman_previewlanguage": "json",
					"header": [],
					"cookie": [],
					"body": "{\n  \"success\": false,\n  \"message\": \"Error al aplicar los costos\",\n  \"error\": \"Detalle del error SQL\"\n}"
				}
			]
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Este script se ejecuta antes de cada request",
					"console.log('üöÄ Ejecutando:', pm.request.name);",
					"",
					"// Verificar si hay token (excepto para login)",
					"if (pm.request.name !== 'Login - Obtener Token JWT') {",
					"    const token = pm.environment.get('jwt_token');",
					"    if (!token) {",
					"        console.warn('‚ö†Ô∏è No hay token JWT. Ejecuta primero el endpoint de Login.');",
					"    }",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Script global para todas las respuestas",
					"console.log('üìä Status:', pm.response.code, pm.response.status);",
					"",
					"// Validar respuestas exitosas",
					"if (pm.response.code === 200) {",
					"    console.log('‚úÖ Request exitoso');",
					"} else if (pm.response.code === 401) {",
					"    console.error('üîí No autorizado - Token inv√°lido o expirado');",
					"} else if (pm.response.code === 400) {",
					"    console.warn('‚ö†Ô∏è Bad Request - Verificar datos enviados');",
					"}"
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:3000",
			"type": "string"
		},
		{
			"key": "jwt_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "username",
			"value": "admin",
			"type": "string"
		},
		{
			"key": "password",
			"value": "tu_password_aqui",
			"type": "string"
		}
	]
}
